
#include <Wire.h>
#include "MPU9250.h"
#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>
#define MPU9250_IMU_ADDRESS  0x68
#define MAGNETIC_DECLINATION 1.63
#define INTERVAL_MS_PRINT    1000
// BLE service + characteristic for Slave 1
#define SERVICE_UUID  "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHAR_UUID1    "beb5483e-36e1-4688-b7f5-ea07361b26a8"
MPU9250 mpu;
unsigned long lastPrintMillis = 0;
float rollOffset = 0.0;
bool calibrated = false;
BLECharacteristic* pChar;
// Arduino-style float mapping
float mapFloat(float x, float in_min, float in_max,
               float out_min, float out_max) {
  if (fabs(in_max - in_min) < 1e-6) return out_min;
  return (x - in_min)*(out_max - out_min)/(in_max - in_min) + out_min;
}
void setup() {
  Serial.begin(115200);
  Wire.begin(19, 18);  // SDA = 19, SCL = 18
  // MPU setup
  MPU9250Setting setting;
  setting.accel_fs_sel    = ACCEL_FS_SEL::A16G;
  setting.gyro_fs_sel     = GYRO_FS_SEL::G1000DPS;
  setting.mag_output_bits = MAG_OUTPUT_BITS::M16BITS;
  setting.fifo_sample_rate= FIFO_SAMPLE_RATE::SMPL_250HZ;
  setting.gyro_fchoice    = 0x03;
  setting.gyro_dlpf_cfg   = GYRO_DLPF_CFG::DLPF_20HZ;
  setting.accel_fchoice   = 0x01;
  setting.accel_dlpf_cfg  = ACCEL_DLPF_CFG::DLPF_45HZ;
  if (!mpu.setup(MPU9250_IMU_ADDRESS, setting)) {
    Serial.println("MPU9250 init failed! Check wiring.");
    while (1) delay(1000);
  }
  mpu.setMagneticDeclination(MAGNETIC_DECLINATION);
  mpu.selectFilter(QuatFilterSel::MADGWICK);
  mpu.setFilterIterations(15);
  // Calibrate accel/gyro
  Serial.println("Calibrating accel/gyro...");
  delay(5000);
  mpu.calibrateAccelGyro();
  // Calibrate mag
  Serial.println("Calibrating mag...");
  delay(5000);
  mpu.calibrateMag();
  // Stabilize filter
  Serial.println("Stabilizing filter...");
  for (int i = 0; i < 200; i++) {
    mpu.update();
    delay(5);
  }
  // Compute flat-position roll offset
  float sum = 0;
  for (int i = 0; i < 100; i++) {
    mpu.update();
    sum += mpu.getRoll();
    delay(10);
  }
  rollOffset = sum / 100.0;
  Serial.printf("Roll offset: %.2f\n", rollOffset);
  calibrated = true;
  // BLE peripheral setup
  BLEDevice::init("ESP32-Slave1");
  BLEServer*  server  = BLEDevice::createServer();
  BLEService* service = server->createService(SERVICE_UUID);
  pChar = service->createCharacteristic(
    CHAR_UUID1,
    BLECharacteristic::PROPERTY_NOTIFY
  );
  pChar->addDescriptor(new BLE2902());
  service->start();
  BLEAdvertising* adv = server->getAdvertising();
  adv->addServiceUUID(SERVICE_UUID);
  adv->setScanResponse(true);
  adv->start();
  Serial.println(">> Slave 1 advertising");
}
void loop() {
  unsigned long now = millis();
  if (calibrated && mpu.update() && now - lastPrintMillis >= INTERVAL_MS_PRINT) {
    float raw = mpu.getRoll();
    float adj = raw - rollOffset;
    // Send over BLE
    char buf[32];
    int len = snprintf(buf, sizeof(buf), "ROLL:%.1f,%.1f", raw, adj);
    pChar->setValue((uint8_t*)buf, len);
    pChar->notify();
    // Also print locally
    Serial.println(buf);
    lastPrintMillis = now;
  }
}
